---
layout: post
title: Collectd patch to collect cpu average on linux
date: '2012-01-05T17:36:00.000-08:00'
author: Daniel Hilst
blogger: true
tags:
- collecting cpu average with collectd
- collectd
- cpu plugin
modified_time: '2012-01-05T17:38:05.218-08:00'
blogger_id: tag:blogger.com,1999:blog-8785437776394405849.post-712532030666517765
blogger_orig_url: http://gkos-hw.blogspot.com/2012/01/collectd-patch-to-collect-cpu-average.html
---

I'm using collectd to collectd data at work -&gt; <a href="http://www.collectd.org/" target="_blank">http://www.collectd.org</a> The cpu plugin don't collectd average cpu usage, I have create a patch to work this around. Here it is<br />  <pre class="brush: text"><br />diff -Nurp collectd-5.0.1/src/cpu.c collectd-5.0.1-new/src/cpu.c<br />--- collectd-5.0.1/src/cpu.c 2011-10-14 17:49:49.000000000 -0300<br />+++ collectd-5.0.1-new/src/cpu.c 2012-01-03 17:48:22.000000000 -0200<br />@@ -252,7 +252,11 @@ static void submit (int cpu_num, const c<br />  vl.values_len = 1;<br />  sstrncpy (vl.host, hostname_g, sizeof (vl.host));<br />  sstrncpy (vl.plugin, "cpu", sizeof (vl.plugin));<br />- ssnprintf (vl.plugin_instance, sizeof (vl.plugin_instance),<br />+        if (cpu_num < 0)<br />+                ssnprintf (vl.plugin_instance, sizeof (vl.plugin_instance),<br />+   "avg");<br />+        else<br />+                ssnprintf (vl.plugin_instance, sizeof (vl.plugin_instance),<br />    "%i", cpu_num);<br />  sstrncpy (vl.type, "cpu", sizeof (vl.type));<br />  sstrncpy (vl.type_instance, type_instance, sizeof (vl.type_instance));<br />@@ -359,6 +363,7 @@ static int cpu_read (void)<br /> <br />  char *fields[9];<br />  int numfields;<br />+        int coren = sysconf(_SC_NPROCESSORS_ONLN); /* number of cores */<br /> <br />  if ((fh = fopen ("/proc/stat", "r")) == NULL)<br />  {<br />@@ -372,18 +377,24 @@ static int cpu_read (void)<br />  {<br />   if (strncmp (buf, "cpu", 3))<br />    continue;<br />-  if ((buf[3] < '0') || (buf[3] > '9'))<br />-   continue;<br /> <br />   numfields = strsplit (buf, fields, 9);<br />   if (numfields < 5)<br />    continue;<br /> <br />-  cpu = atoi (fields[0] + 3);<br />-  user = atoll (fields[1]);<br />-  nice = atoll (fields[2]);<br />-  syst = atoll (fields[3]);<br />-  idle = atoll (fields[4]);<br />+                if (!isdigit(fields[0][3])) {<br />+                        cpu = -1;<br />+                        user = atoll (fields[1]) / coren;<br />+                        nice = atoll (fields[2]) / coren;<br />+                        syst = atoll (fields[3]) / coren;<br />+                        idle = atoll (fields[4]) / coren;<br />+                } else { <br />+          cpu = atoi (fields[0] + 3);<br />+                        user = atoll (fields[1]);<br />+                        nice = atoll (fields[2]);<br />+                        syst = atoll (fields[3]);<br />+                        idle = atoll (fields[4]);<br />+                }<br /> <br />   submit (cpu, "user", user);<br />   submit (cpu, "nice", nice);<br />@@ -392,9 +403,15 @@ static int cpu_read (void)<br /> <br />   if (numfields >= 8)<br />   {<br />-   wait = atoll (fields[5]);<br />-   intr = atoll (fields[6]);<br />-   sitr = atoll (fields[7]);<br />+                        if (cpu < 0) {<br />+                                wait = atoll (fields[5]) / coren;<br />+                                intr = atoll (fields[6]) / coren;<br />+                                sitr = atoll (fields[7]) / coren;<br />+                        } else {<br />+                                wait = atoll (fields[5]);<br />+                                intr = atoll (fields[6]);<br />+                                sitr = atoll (fields[7]);<br />+                        }<br /> <br />    submit (cpu, "wait", wait);<br />    submit (cpu, "interrupt", intr);<br /><br /><br /></pre>