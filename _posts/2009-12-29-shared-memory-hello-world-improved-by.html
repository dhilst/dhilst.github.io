---
layout: post
title: shared memory hello world improved by signals
date: '2009-12-29T08:59:00.000-08:00'
author: Daniel Hilst
blogger: true
tags: 
modified_time: '2009-12-29T08:59:35.432-08:00'
blogger_id: tag:blogger.com,1999:blog-8785437776394405849.post-6609342086589880157
blogger_orig_url: http://gkos-hw.blogspot.com/2009/12/shared-memory-hello-world-improved-by.html
---

<pre class="brush: c">/* file: shared-write.c<br />   compiling: gcc -o shared-write shared-write.c */<br />#include &lt;stdlib.h&gt;<br />#include &lt;string.h&gt;<br />#include &lt;signal.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;sys/shm.h&gt;<br /><br /><br />/* Make this global, so visible inside handler */<br />static char * shared_memory;<br />static int segment_id;<br /><br /><br /> /* SIGNAL handler<br /> detach and deallocate  */<br />void<br />handler (int signumber)<br />{<br />  shmdt (shared_memory);<br />  shmctl (segment_id, IPC_RMID, 0);<br />  exit (0);<br />}<br /><br />int<br />main (void)<br />{<br />  key_t key = 2525;<br />  int segment_size = 0x6400;<br />  /* Needed for signal handler */<br />  struct sigaction sa;<br />  /* install signal handler */<br />  sa.sa_handler = & handler;<br />  sigaction (SIGUSR1, &sa, NULL);<br />  <br />  /* get a shareable segment */<br />  segment_id = shmget (key, segment_size, IPC_CREAT | 0666);<br />  /* attach it with shared_memory */<br />  shared_memory = shmat (segment_id, NULL, 0);<br />  /* write into */<br />  sprintf (shared_memory, "0%d,Hello World", getpid());<br />  <br />  /* wait for signal */<br />  while (1)<br /> sleep (1);<br />  <br />  /* the program must exit through handler */<br />  return -1;<br />}<br /></pre><pre class="brush: c">/* file: shared-read.c<br />   compiling: gcc -o shared-read shared-read.c */<br />#include &lt;string.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;sys/shm.h&gt;<br />#include &lt;signal.h&gt;<br />#include &lt;sys/types.h&gt;<br /><br />int <br />main (void)<br />{<br />  int segment_id;<br />  pid_t pid_of_brother;<br />  key_t key = 2525;<br />  char * shared_memory, string;<br />  int segment_size = 0x6400;<br />  char * ptr1, * ptr2, * ptr3;<br />  <br />  /* get the shared segment, using the same key */<br />  segment_id = shmget (key, segment_size, 0666);<br />  /* attaching */<br />  shared_memory = shmat (segment_id, NULL, 0);<br />  /* There is pid of the other process and a string<br />  split by a comma. Take the 2 values by walk<br />  through pointers */<br />  ptr1 = strchr (shared_memory, ','); <br />  /* here I got the pid. If the pid is 4 numbers then<br />  one 0 is taken at begining of pid */<br />  ptr2 = ptr1 - 5;<br />  /* and here is string */<br />  ptr3 = ptr1 + 1;<br />  /* conver pid to pid type */<br />  pid_of_brother = (pid_t) atoi (ptr2);<br />  /* write string to stdout */<br />  printf ("%s\n", ptr3);<br />  /* send SIGUSR1 signal to other process<br />  saying HEY I FINISH <br />  so it can detach and deallocate the <br />  shared memory */<br />  kill (pid_of_brother, SIGUSR1);<br /><br />  return 0;<br />}<br /></pre>running:<br />$ ./shared-write &<br />[1] 2026<br />$ ./shared-read<br />Hello World<br />[1]+ Done ./shared-write